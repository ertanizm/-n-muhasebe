<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mutabık - Cari Ekstresi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/css/dashboard.css" rel="stylesheet">
    <link href="/css/musteriler.css" rel="stylesheet">
    <link href="/css/cariekstre.css" rel="stylesheet">
    <link href="/css/filtre.css" rel="stylesheet">
</head>
<body>
    <%- include('../sidebar') %>

    <div class="main-content">
        <div class="product-container">
            <div class="page-header">
                <h1 class="page-title">Cari Ekstresi</h1>
                <div class="action-buttons">
                    <div class="export-buttons">
                        <button class="btn btn-outline-success btn-export" onclick="exportToExcel()">
                            <i class="fas fa-file-excel"></i> Excel
                        </button>
                        <button class="btn btn-outline-danger btn-export" onclick="exportToPDF()">
                            <i class="fas fa-file-pdf"></i> PDF
                        </button>
                        <button class="btn btn-outline-primary btn-export" onclick="printReport()">
                            <i class="fas fa-print"></i> Yazdır
                        </button>
                    </div>
                </div>
            </div>

            <!-- Filtreler -->
            <div class="filter-card">
                <div class="filter-header">
                    <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filtreler</h5>
                    <button class="btn btn-sm btn-outline-secondary" onclick="toggleFilters()">
                        <i class="fas fa-chevron-up" id="filterToggleIcon"></i>
                    </button>
                </div>
                <div class="filter-content" id="filterContent">
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Cari Kodu/Adı</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control form-control-md" id="cariArama" placeholder="Cari ara...">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-bold">Hareket Türü</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-tags"></i></span>
                                <select class="form-select form-select-lg" id="hareketTuru">
                                    <option value="">Tümü</option>
                                    <% if (typeof hareketTurleri !== 'undefined') { %>
                                        <% hareketTurleri.forEach(function(tur) { %>
                                            <option value="<%= tur.tur_kodu %>"><%= tur.tur_adi %></option>
                                        <% }); %>
                                    <% } %>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-bold">Depo</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-warehouse"></i></span>
                                <select class="form-select form-select-lg" id="depoId">
                                    <option value="">Tümü</option>
                                    <% if (typeof depolar !== 'undefined') { %>
                                        <% depolar.forEach(function(depo) { %>
                                            <option value="<%= depo.id %>"><%= depo.depo_adi %></option>
                                        <% }); %>
                                    <% } %>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Tarih Aralığı</label>
                            <div class="d-flex align-items-center gap-2"> <!-- buraya d-flex eklendi -->
                                <div class="input-group input-group-md">
                                    <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                                    <input type="date" class="form-control" id="baslangicTarih" value="2025-01-01">
                                </div>
                                <span class="mx-1">-</span> <!-- araya tire işareti -->
                                <div class="input-group input-group-md">
                                    <input type="date" class="form-control" id="bitisTarih" value="2025-12-31">
                                    <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Başlangıç Bakiyesi</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-coins"></i></span>
                                <input type="number" class="form-control form-control-md" id="baslangicBakiye" placeholder="0" value="0" min="0">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Bitiş Bakiyesi</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-coins"></i></span>
                                <input type="number" class="form-control form-control-md" id="bitisBakiye" placeholder="0" value="999999" min="0">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Sıralama</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-sort"></i></span>
                                <select class="form-select form-select-lg" id="siralama">
                                    <option value="date">Tarih</option>
                                    <option value="type">Hareket Türü</option>
                                    <option value="quantity">Miktar</option>
                                    <option value="amount">Tutar</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3 justify-content-end d-flex align-items-end">
                            <button class="btn btn-primary me-2 btn-lg" onclick="searchHareketler()">
                                <i class="fas fa-search"></i> Ara
                            </button>
                            <button class="btn btn-outline-secondary btn-lg" onclick="clearFilters()">
                                <i class="fas fa-times"></i> Temizle
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Özet Kartları -->
            <div class="summary-cards" id="ozetKartlari">
                <div class="summary-card">
                    <div class="value positive" id="toplamGiris">+0,00</div>
                    <div class="label">Toplam Giriş</div>
                </div>
                <div class="summary-card">
                    <div class="value negative" id="toplamCikis">-0,00</div>
                    <div class="label">Toplam Çıkış</div>
                </div>
                <div class="summary-card">
                    <div class="value" id="toplamBakiye">0,00</div>
                    <div class="label">Mevcut Stok</div>
                </div>
                <div class="summary-card">
                    <div class="value" id="hareketSayisi">0</div>
                    <div class="label">Hareket Sayısı</div>
                </div>
                <div class="summary-card d-none">
                    <div class="value" id="stokDegeri">₺0,00</div>
                    <div class="label">Stok Değeri</div>
                </div>
            </div>

            <!-- Stok Hareketleri Tablosu -->
            <div id="printArea" class="movement-table">
                <table class="table table-hover" id="hareketTablosu">
                    <thead>
                        <tr>
                            <th>Tarih</th>
                            <th>Hareket Türü</th>
                            <th>Belge No</th>
                            <th>Cari</th>
                            <th>Depo</th>
                            <th>Giriş</th>
                            <th>Çıkış</th>
                            <th>Bakiye</th>
                            <th>Açıklama</th>
                            <th class="no-print">İşlemler</th>
                        </tr>
                    </thead>
                    <tbody id="hareketTablosuBody">
                        <tr>
                            <td colspan="12" class="text-center">Veriler yükleniyor...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Sayfalama -->
            <div class="pagination-wrapper">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <small class="text-muted" id="kayitBilgisi">
                            Toplam 0 kayıt gösteriliyor
                        </small>
                    </div>
                    <div class="col-md-6">
                        <nav aria-label="Cari hareketleri sayfalama">
                            <ul class="pagination pagination-sm justify-content-end mb-0" id="sayfalama">
                                <li class="page-item disabled">
                                    <a class="page-link" href="#" tabindex="-1">Önceki</a>
                                </li>
                                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                <li class="page-item">
                                    <a class="page-link" href="#">Sonraki</a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/script.js"></script>
    <script>
        // Sayfa yüklendiğinde varsayılan arama yap
        document.addEventListener('DOMContentLoaded', function() {
            searchHareketler();
        });

        // Cari hareket arama
        function searchHareketler() {
            const filters = {
                cari_arama: document.getElementById('cariArama').value,
                hareket_turu: document.getElementById('hareketTuru').value,
                depo_id: document.getElementById('depoId').value,
                baslangic_tarih: document.getElementById('baslangicTarih').value,
                bitis_tarih: document.getElementById('bitisTarih').value,
                baslangic_bakiye: document.getElementById('baslangicBakiye').value,
                bitis_bakiye: document.getElementById('bitisBakiye').value,
                siralama: document.getElementById('siralama').value
            };

            fetch('/cari/cariekstre/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(filters)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateHareketTablosu(data.hareketler);
                    updateOzetKartlari(data.ozet);
                    updateKayitBilgisi(data.hareketler.length);
                } else {
                    console.error('Backend hatası:', data);
                    alert('Arama sırasında hata oluştu: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Arama hatası:', error);
                console.error('Hata detayı:', error.message);
                alert('Arama sırasında hata oluştu: ' + error.message);
            });
        }

        // Hareket tablosunu güncelle
        function updateHareketTablosu(hareketler) {
            const tbody = document.getElementById('hareketTablosuBody');
            tbody.innerHTML = '';

            if (hareketler.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" class="text-center">Hareket bulunamadı</td></tr>';
                return;
            }

            hareketler.forEach(hareket => {
                const row = document.createElement('tr');
                row.setAttribute('data-id', hareket.id);
                
                const tarih = new Date(hareket.tarih).toLocaleDateString('tr-TR');
                
                // Sayısal değerleri düzgün formatla
                const formatNumber = (num) => {
                    if (num === null || num === undefined || isNaN(num)) return '0,00';
                    const number = parseFloat(num) || 0;
                    return number.toLocaleString('tr-TR', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                };

                const girisText = hareket.giris_miktar > 0 ? '+' + formatNumber(hareket.giris_miktar) : '-';
                const cikisText = hareket.cikis_miktar > 0 ? '-' + formatNumber(hareket.cikis_miktar) : '-';
                const bakiyeText = formatNumber(hareket.bakiye);
                const birimFiyat = hareket.birim_fiyat && hareket.birim_fiyat !== null ? formatNumber(hareket.birim_fiyat) : '0,00';
                const toplamTutar = hareket.toplam_tutar && hareket.toplam_tutar !== null ? formatNumber(hareket.toplam_tutar) : '0,00';

                row.innerHTML = `
                    <td>${tarih}</td>
                    <td><span class="movement-type ${hareket.hareket_turu.toLowerCase()}">${hareket.hareket_turu}</span></td>
                    <td>${hareket.belge_no || '-'}</td>
                    <td>${hareket.cari_adi || '-'}</td>
                    <td>${hareket.depo_adi || '-'}</td>
                    <td class="quantity-positive">${girisText}</td>
                    <td class="quantity-negative">${cikisText}</td>
                    <td class="balance-positive">${bakiyeText}</td>
                    <td>${hareket.aciklama || '-'}</td>
                    <td class="no-print">
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteHareket(${hareket.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Özet kartlarını güncelle
        function updateOzetKartlari(ozet) {
            // Sayısal değerleri düzgün formatla
            const formatNumber = (num) => {
                if (num === null || num === undefined || isNaN(num)) return '0,00';
                const number = parseFloat(num) || 0;
                return number.toLocaleString('tr-TR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            };

            const formatInteger = (num) => {
                if (num === null || num === undefined || isNaN(num)) return '0';
                const number = parseInt(num) || 0;
                return number.toLocaleString('tr-TR');
            };

            // Özet verilerini güvenli şekilde al
            const toplamGiris = ozet && ozet.toplamGiris !== undefined ? ozet.toplamGiris : 0;
            const toplamCikis = ozet && ozet.toplamCikis !== undefined ? ozet.toplamCikis : 0;
            const mevcutStok = ozet && ozet.mevcutStok !== undefined ? ozet.mevcutStok : 0;
            const hareketSayisi = ozet && ozet.hareketSayisi !== undefined ? ozet.hareketSayisi : 0;
            const stokDegeri = ozet && ozet.stokDegeri !== undefined ? ozet.stokDegeri : 0;

            document.getElementById('toplamGiris').textContent = '+' + formatNumber(toplamGiris);
            document.getElementById('toplamCikis').textContent = '-' + formatNumber(toplamCikis);
            document.getElementById('toplamBakiye').textContent = formatNumber(mevcutStok);
            document.getElementById('hareketSayisi').textContent = formatInteger(hareketSayisi);
            document.getElementById('stokDegeri').textContent = '₺' + formatNumber(stokDegeri);
        }

        // Kayıt bilgisini güncelle
        function updateKayitBilgisi(count) {
            document.getElementById('kayitBilgisi').textContent = `Toplam ${count} kayıt gösteriliyor`;
        }

        // Filtreleri temizle
        function clearFilters() {
            document.getElementById('cariArama').value = '';
            document.getElementById('hareketTuru').value = '';
            document.getElementById('depoId').value = '';
            document.getElementById('baslangicTarih').value = '2025-01-01';
            document.getElementById('bitisTarih').value = '2025-12-31';
            document.getElementById('baslangicBakiye').value = '0';
            document.getElementById('bitisBakiye').value = '999999';
            document.getElementById('siralama').value = 'date';
            searchHareketler();
        }

        // Hareket silme
        function deleteHareket(id) {
            if (confirm('Bu hareketi silmek istediğinizden emin misiniz?')) {
                fetch(`/cari/cariekstre/hareket/${id}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        searchHareketler(); // Tabloyu yenile
                    } else {
                        alert('Hareket silinirken hata oluştu: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Silme hatası:', error);
                    alert('Hareket silinirken hata oluştu');
                });
            }
        }

        // Export fonksiyonları
        function exportToExcel() {
            alert('Excel export işlemi başlatıldı');
            // Excel export implementasyonu buraya eklenebilir
        }

        function exportToPDF() {
            alert('PDF export işlemi başlatıldı');
            // PDF export implementasyonu buraya eklenebilir
        }

        function printReport() {
            window.print();
        }

        // Filtre toggle fonksiyonu
        function toggleFilters() {
            const filterContent = document.getElementById('filterContent');
            const toggleIcon = document.getElementById('filterToggleIcon');
            
            if (filterContent.classList.contains('collapsed')) {
                filterContent.classList.remove('collapsed');
                toggleIcon.classList.remove('fa-chevron-down');
                toggleIcon.classList.add('fa-chevron-up');
            } else {
                filterContent.classList.add('collapsed');
                toggleIcon.classList.remove('fa-chevron-up');
                toggleIcon.classList.add('fa-chevron-down');
            }
        }

        // Filtreleri dışa aktar
        function exportFilters() {
            const filters = {
                cari_arama: document.getElementById('cariArama').value,
                hareket_turu: document.getElementById('hareketTuru').value,
                depo_id: document.getElementById('depoId').value,
                baslangic_tarih: document.getElementById('baslangicTarih').value,
                bitis_tarih: document.getElementById('bitisTarih').value,
                baslangic_bakiye: document.getElementById('baslangicBakiye').value,
                bitis_bakiye: document.getElementById('bitisBakiye').value,
                siralama: document.getElementById('siralama').value
            };
            
            const filterText = Object.entries(filters)
                .filter(([key, value]) => value)
                .map(([key, value]) => `${key}: ${value}`)
                .join('\n');
            
            const blob = new Blob([filterText], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'cari_filtreleri.txt';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Filtre değişikliklerini dinle
        document.querySelectorAll('#cariArama, #hareketTuru, #depoId, #baslangicTarih, #bitisTarih, #baslangicBakiye, #bitisBakiye, #siralama').forEach(input => {
            input.addEventListener('change', function() {
                // Otomatik arama için debounce eklenebilir
                console.log('Filtre değişti:', this.id, this.value);
            });
        });

        // Enter tuşu ile arama
        document.querySelectorAll('#cariArama, #baslangicBakiye, #bitisBakiye').forEach(input => {
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchHareketler();
                }
            });
        });
    </script>
</body>
</html> 