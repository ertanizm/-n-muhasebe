<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mutabık - Cariler</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/css/dashboard.css" rel="stylesheet">
    <link href="/css/musteriler.css" rel="stylesheet">
    <link href="/css/filtre.css" rel="stylesheet">
</head>
<body>
    <%- include('../sidebar') %>

    <div class="main-content">
        <div class="customer-container">
            <div class="page-header">
                <h1 class="page-title">Cariler</h1>
                <div class="action-buttons">
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCustomerModal">
                        <i class="fas fa-plus"></i>
                        <span>Yeni Cari</span>
                    </button>
                    <a href="/cari/musteriler/export" style="color: white;" class="btn btn-info">
                        <i class="fas fa-file-export"></i>
                        <span>Dışa Aktar</span>
                    </a>
                </div>
            </div>

            <!-- Filtreler  -->
            <div class="filter-card">
                <div class="filter-header">
                    <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filtreler</h5>
                    <button class="btn btn-sm btn-outline-secondary" onclick="toggleFilters()">
                        <i class="fas fa-chevron-up" id="filterToggleIcon"></i>
                    </button>
                </div>
                <div class="filter-content" id="filterContent">
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Cari Kodu/Adı</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control form-control-md" id="cariArama" placeholder="Cari ara...">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-bold">Müşteri Türü</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-tags"></i></span>
                                <select class="form-select form-select-lg" id="cariTuru">
                                    <option value="">Tümü</option>
                                    <option value="0">Müşteri</option>
                                    <option value="1">Tedarikçi</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Sıralama</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-sort"></i></span>
                                <select class="form-select form-select-lg" id="siralama">
                                    <option value="">Tarih</option>
                                    <option value="name">Cari Kodu</option>
                                    <option value="unvan">Cari Adı</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3 justify-content-end d-flex align-items-end">
                            <button class="btn btn-primary me-2 btn-lg" onclick="searchCariler()">
                                <i class="fas fa-search"></i> Ara
                            </button>
                            <button class="btn btn-outline-secondary btn-lg" onclick="clearFilters()">
                                <i class="fas fa-times"></i> Temizle
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="customers-table">
                <table class="table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Cari Kodu</th>
                            <th>Unvan</th>
                            <th>Aktif</th>
                            <th>İl</th>
                            <th>İlçe</th>
                            <th>Adres</th>
                            <th>Vergi Dairesi</th>
                            <th>Vergi No</th>
                            <th>Telefon</th>
                            <th>Email</th>
                            <th>İşlemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (customers && customers.length > 0) { %>
                            <% customers.forEach(function(c, i) { %>
                                <tr>
                                    <td><%= c.id %></td>
                                    <td><%= c.carikodu %></td>
                                    <td><%= c.unvan %></td>
                                    <td><%= c.aktif ? 'Evet' : 'Hayır' %></td>
                                    <td><%= c.il %></td>
                                    <td><%= c.ilce %></td>
                                    <td><%= c.adres %></td>
                                    <td><%= c.vergi_dairesi %></td>
                                    <td><%= c.vergi_no %></td>
                                    <td><%= c.telefon %></td>
                                    <td><%= c.email %></td>
                                    <td class="action-buttons">
                                        <button class="btn btn-sm btn-warning me-1 edit-btn" 
                                            data-id="<%= c.id %>"
                                            data-carikodu="<%= c.carikodu %>"
                                            data-unvan="<%= c.unvan %>"
                                            data-aktif="<%= c.aktif %>"
                                            data-type="<%= c.type %>"
                                            data-il="<%= c.il %>"
                                            data-ilce="<%= c.ilce %>"
                                            data-adres="<%= c.adres %>"
                                            data-vergi_dairesi="<%= c.vergi_dairesi %>"
                                            data-vergi_no="<%= c.vergi_no %>"
                                            data-telefon="<%= c.telefon %>"
                                            data-email="<%= c.email %>"
                                            data-resmi="<%= c.resmi %>"
                                            data-vadeopsiyonu="<%= c.vadeopsiyonu %>"
                                            data-bakiye="<%= c.bakiye %>"
                                            data-alacak="<%= c.alacak %>"
                                            data-borc="<%= c.borc %>"
                                            data-guncelleyenkullanicikayitno="<%= c.guncelleyenkullanicikayitno %>"
                                            data-kaydedenkullanicikayitno="<%= c.kaydedenkullanicikayitno %>"
                                            data-efatura="<%= c.efatura %>"
                                            data-efaturasenaryo="<%= c.efaturasenaryo %>"
                                            data-efaturalicietiketi="<%= c.efaturalicietiketi %>"
                                        >
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger delete-btn" data-id="<%= c.id %>">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </td>
                                </tr>
                            <% }) %>
                        <% } else { %>
                            <tr><td colspan="12">Kayıt bulunamadı.</td></tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addCustomerModal" tabindex="-1" aria-labelledby="addCustomerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addCustomerModalLabel">Yeni Müşteri Ekle</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
                </div>
                <div class="modal-body">
                    <form id="customerForm">
                        <input type="hidden" id="customerId" name="id">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="carikodu" class="form-label">Cari Kodu</label>
                                <input type="text" class="form-control" id="carikodu" name="carikodu">
                            </div>
                            <div class="col-md-4">
                                <label for="unvan" class="form-label">Unvan *</label>
                                <input type="text" class="form-control" id="unvan" name="unvan" required>
                            </div>
                            <div class="col-md-4">
                                <label for="aktif" class="form-label">Aktif</label>
                                <select class="form-control" id="aktif" name="aktif">
                                    <option value="1">Evet</option>
                                    <option value="0">Hayır</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="type" class="form-label">Cari Tipi</label>
                                <select class="form-control" id="type" name="type">
                                    <option value="0" selected>Müşteri</option>
                                    <option value="1">Tedarikçi</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="il" class="form-label">İl</label>
                                <input type="text" class="form-control" id="il" name="il">
                            </div>
                            <div class="col-md-4">
                                <label for="ilce" class="form-label">İlçe</label>
                                <input type="text" class="form-control" id="ilce" name="ilce">
                            </div>
                            <div class="col-md-4">
                                <label for="adres" class="form-label">Adres</label>
                                <input type="text" class="form-control" id="adres" name="adres">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="vergi_dairesi" class="form-label">Vergi Dairesi</label>
                                <input type="text" class="form-control" id="vergi_dairesi" name="vergi_dairesi">
                            </div>
                            <div class="col-md-4">
                                <label for="vergi_no" class="form-label">Vergi No</label>
                                <input type="text" class="form-control" id="vergi_no" name="vergi_no">
                            </div>
                            <div class="col-md-4">
                                <label for="telefon" class="form-label">Telefon</label>
                                <input type="text" class="form-control" id="telefon" name="telefon">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" name="email">
                            </div>
                            <div class="col-md-4">
                                <label for="resmi" class="form-label">Resmi</label>
                                <input type="text" class="form-control" id="resmi" name="resmi">
                            </div>
                            <div class="col-md-4">
                                <label for="vadeopsiyonu" class="form-label">Vade Opsiyonu</label>
                                <input type="text" class="form-control" id="vadeopsiyonu" name="vadeopsiyonu">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="bakiye" class="form-label">Bakiye</label>
                                <input type="number" step="0.01" class="form-control" id="bakiye" name="bakiye">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="efatura" class="form-label">e-Fatura</label>
                                <select class="form-control" id="efatura" name="efatura">
                                    <option value="0">Hayır</option>
                                    <option value="1">Evet</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="efaturasenaryo" class="form-label">e-Fatura Senaryo</label>
                                <input type="text" class="form-control" id="efaturasenaryo" name="efaturasenaryo">
                            </div>
                            <div class="col-md-6">
                                <label for="efaturalicietiketi" class="form-label">e-Fatura Etiketi</label>
                                <input type="text" class="form-control" id="efaturalicietiketi" name="efaturalicietiketi">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-primary" id="saveCustomer">Kaydet</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/script.js"></script>
    <script>
        document.getElementById('saveCustomer').addEventListener('click', async function() {
            const form = document.getElementById('customerForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetch('/cari/musteriler', {  // Update API endpoint
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (result.success) {
                    location.reload(); // Sayfayı yenile
                } else {
                    alert('Kayıt sırasında bir hata oluştu: ' + result.message);
                }
            } catch (error) {
                alert('İşlem sırasında bir hata oluştu');
            }
        });

        // Update delete endpoint
        document.querySelector('.customers-table tbody').addEventListener('click', async (e) => {
            const btn = e.target.closest('.delete-btn');
            if (!btn) return;

            if (!confirm('Müşteriyi silmek istediğinize emin misiniz?')) return;

            const id = btn.dataset.id;
            const response = await fetch(`/cari/musteriler/${id}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' }
            });

            const result = await response.json();
            if (result.success) {
                btn.closest('tr').remove();
                alert('Müşteri başarıyla silindi.');
            } else {
                alert('Silme işlemi başarısız: ' + result.message);
            }
        });


        // Edit butonu için event listener
        document.querySelector('.customers-table tbody').addEventListener('click', (e) => {
            const btn = e.target.closest('.edit-btn');
            if (!btn) return;

            const modal = new bootstrap.Modal(document.getElementById('addCustomerModal'));
            const form = document.getElementById('customerForm');

            // Form alanlarını doldur
            form.id.value = btn.dataset.id || '';
            form.carikodu.value = btn.dataset.carikodu || '';
            form.unvan.value = btn.dataset.unvan || '';
            form.aktif.value = btn.dataset.aktif || 'false';
            form.type.value = btn.dataset.type || '0';
            form.il.value = btn.dataset.il || '';
            form.ilce.value = btn.dataset.ilce || '';
            form.adres.value = btn.dataset.adres || '';
            form.vergi_dairesi.value = btn.dataset.vergi_dairesi || '';
            form.vergi_no.value = btn.dataset.vergi_no || '';
            form.telefon.value = btn.dataset.telefon || '';
            form.email.value = btn.dataset.email || '';
            form.resmi.value = btn.dataset.resmi || '';
            form.vadeopsiyonu.value = btn.dataset.vadeopsiyonu || '';
            form.bakiye.value = btn.dataset.bakiye || '';
            form.efatura.value = btn.dataset.efatura || '';
            form.efaturasenaryo.value = btn.dataset.efaturasenaryo || '';
            form.efaturalicietiketi.value = btn.dataset.efaturalicietiketi || '';

            // Modal başlığını güncelle
            document.getElementById('addCustomerModalLabel').textContent = 'Müşteri Düzenle';

            modal.show();
        });


        // Filtre toggle fonksiyonu
        function toggleFilters() {
                    const filterContent = document.getElementById('filterContent');
                    const toggleIcon = document.getElementById('filterToggleIcon');
                    
                    if (filterContent.classList.contains('collapsed')) {
                        filterContent.classList.remove('collapsed');
                        toggleIcon.classList.remove('fa-chevron-down');
                        toggleIcon.classList.add('fa-chevron-up');
                    } else {
                        filterContent.classList.add('collapsed');
                        toggleIcon.classList.remove('fa-chevron-up');
                        toggleIcon.classList.add('fa-chevron-down');
                    }
                }
            
        function clearFilters() {
            document.getElementById('cariArama').value = "";
            document.getElementById('cariTuru').value = "";
            document.getElementById('siralama').value = "";
            searchCariler();
        } 

         // Cari hareket arama
         function searchCariler() {
            const filters = {
                cari_arama: document.getElementById('cariArama').value,
                cari_turu: document.getElementById('cariTuru').value,
                siralama: document.getElementById('siralama').value
            };

            fetch('/cari/musteriler/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(filters)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateCariTablosu(data.cariler);
                } else {
                    console.error('Backend hatası:', data);
                    alert('Arama sırasında hata oluştu: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Arama hatası:', error);
                console.error('Hata detayı:', error.message);
                alert('Arama sırasında hata oluştu: ' + error.message);
            });
        }

        // Hareket tablosunu güncelle
        function updateCariTablosu(cariler) {
            const tbody = document.querySelector('.customers-table tbody');
            tbody.innerHTML = '';

            if (cariler.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" class="text-center">Hareket bulunamadı</td></tr>';
                return;
            }

            cariler.forEach(c => {
                const row = document.createElement('tr');
                row.setAttribute('data-id', c.id);
                
                row.innerHTML = `
                    <td>${c.id}</td>
                    <td>${c.carikodu}</td>
                    <td>${c.unvan}</td>
                    <td>${c.aktif ? 'Evet' : 'Hayır'}</td>
                    <td>${c.il || '-'}</td>
                    <td>${c.ilce || '-'}</td>
                    <td>${c.adres || '-'}</td>
                    <td>${c.vergi_dairesi || '-'}</td>
                    <td>${c.vergi_no || '-'}</td>
                    <td>${c.telefon || '-'}</td>
                    <td>${c.email || '-'}</td>
                    <td class="no-print">
                        <button class="btn btn-sm btn-warning me-1 edit-btn"
                            data-id="${c.id}"
                            data-carikodu="${c.carikodu}"
                            data-unvan="${c.unvan}"
                            data-aktif="${c.aktif}"
                            data-type="${c.type}"
                            data-il="${c.il}"
                            data-ilce="${c.ilce}"
                            data-adres="${c.adres}"
                            data-vergi_dairesi="${c.vergi_dairesi}"
                            data-vergi_no="${c.vergi_no}"
                            data-telefon="${c.telefon}"
                            data-email="${c.email}"
                            data-resmi="${c.resmi}"
                            data-vadeopsiyonu="${c.vadeopsiyonu}"
                            data-bakiye="${c.bakiye}"
                            data-alacak="${c.alacak}"
                            data-borc="${c.borc}"
                            data-guncelleyenkullanicikayitno="${c.guncelleyenkullanicikayitno}"
                            data-kaydedenkullanicikayitno="${c.kaydedenkullanicikayitno}"
                            data-efatura="${c.efatura}"
                            data-efaturasenaryo="${c.efaturasenaryo}"
                            data-efaturalicietiketi="${c.efaturalicietiketi}"
                        >
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger delete-btn" data-id="${c.id}">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>

                `;
                tbody.appendChild(row);
            });
        }

        // Enter tuşu ile arama
        document.querySelectorAll('#cariArama').forEach(input => {
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchCariler();
                }
            });
        });


    </script>
</body>
</html>
