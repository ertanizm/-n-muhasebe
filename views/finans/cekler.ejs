<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Çekler</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/css/dashboard.css" rel="stylesheet">
    <link href="/css/musteriler.css" rel="stylesheet">
    <link href="/css/filtre.css" rel="stylesheet">

</head>
<body>
    <%- include('../sidebar') %>
    <div class="main-content">
        <div class="product-container">

            <div class="page-header">
                <h1 class="page-title">Çekler</h1>
                <div class="action-buttons">
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCekModal" id="addCekBtn">
                        <i class="fas fa-plus"></i>
                        <span>Yeni Çek</span>
                    </button>
                    <div class="export-buttons">
                        <button class="btn btn-outline-success btn-export" onclick="exportToExcel()">
                            <i class="fas fa-file-excel"></i> Excel
                        </button>
                        <button class="btn btn-outline-danger btn-export" onclick="exportToPDF()">
                            <i class="fas fa-file-pdf"></i> PDF
                        </button>
                        <button class="btn btn-outline-primary btn-export" onclick="printReport()">
                            <i class="fas fa-print"></i> Yazdır
                        </button>
                    </div>
                </div>
            </div>

            <!-- Filtreler -->
            <div class="filter-card">
                <div class="filter-header">
                    <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filtreler</h5>
                    <button class="btn btn-sm btn-outline-secondary" onclick="toggleFilters()">
                        <i class="fas fa-chevron-up" id="filterToggleIcon"></i>
                    </button>
                </div>
                <div class="filter-content" id="filterContent">
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Cari Kodu/Adı</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control " id="cariArama" placeholder="Cari ara...">
                            </div>
                        </div> <div class="col-md-3">
                            <label class="form-label fw-bold">Çek No</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control " id="cek_no" placeholder="Çek No ara...">

                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Tarih Aralığı</label>
                            <div class="d-flex align-items-center gap-2"> <!-- buraya d-flex eklendi -->
                                <div class="input-group ">
                                    <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                                    <input type="date" class="form-control" id="baslangicTarih" value="2025-01-01">
                                </div>
                                <span class="mx-1">-</span> <!-- araya tire işareti -->
                                <div class="input-group ">
                                    <input type="date" class="form-control" id="bitisTarih" value="2025-12-31">
                                    <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                                </div>
                            </div>
                        </div>
                       
                        
                    </div>
                    <div class="row mt-3 ">
                        <div class="col-md-3">
                            <label class="form-label fw-bold">İşlem Tipi</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-tags"></i></span>
                                <select class="form-select" id="islem_tipi">
                                    <option value="">Tümü</option>
                                    <option value="0">Alış</option>
                                    <option value="1">Çıkış</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Durum</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-tags"></i></span>
                                <select class="form-select " id="durum">
                                    <option value="">Tümü</option>
                                    <option value="1">Ciro Edildi</option>
                                    <option value="2">Tahsis Edildi</option>
                                    <option value="3">Portföyde</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Sıralama</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-sort"></i></span>
                                <select class="form-select " id="siralama">
                                    <option value="date">Tarih</option>
                                    <option value="type">Hareket Türü</option>
                                    <option value="quantity">Miktar</option>
                                    <option value="amount">Tutar</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3 d-flex justify-content-end align-items-end gap-2 text-end mt-md-4">
                            <button class="btn btn-primary " onclick="searchCekler()">
                                <i class="fas fa-search"></i> Ara
                            </button>
                            <button class="btn btn-outline-secondary " onclick="clearFilters()">
                                <i class="fas fa-times"></i> Temizle
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="printArea" class="products-table">
                <div class="products-tabs mt-4">
                    <div class="tab-content mt-3" id="cekTabContent">
                        <!-- GENEL BİLGİLER -->
                        <div class="tab-pane fade show active" id="genel" role="tabpanel">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Cari</th>
                                        <th>Kasa/Banka</th>
                                        <th>Çek No</th>
                                        <th>Vade</th>
                                        <th>Tutar</th>
                                        <th>İşlem Tipi</th>
                                        <th>Durum</th>
                                        <th>Açıklama</th>
                                        <th class="no-print">İşlemler</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% cekler.forEach(function(cek) { %>
                                    <tr>
                                        <td><%= cek.id %></td>
                                        <td><%= cek.cari_adi || 'Belirtilmemiş' %></td>
                                        <td><%= cek.hesap_adi || 'Belirtilmemiş' %></td>
                                        <td><%= cek.cek_no %></td>
                                        <td><%= cek.vade_formatted || '' %></td>                                        <td><%= cek.tutar %></td>
                                        <td><%= cek.islem_tipi_text %></td>
                                        <td><%= cek.durum_text %></td>
                                        <td><%= cek.aciklama %></td>
                                        <td class="no-print">
                                            <button class="btn btn-sm btn-warning me-1 edit-btn"
                                                data-id="<%= cek.id %>"
                                                data-cari_id="<%= cek.cari_id %>"
                                                data-cari_adi="<%= cek.cari_adi %>"
                                                data-kasa_banka_id="<%= cek.kasa_banka_id %>"
                                                data-hesap_adi="<%= cek.hesap_adi %>"
                                                data-cek_no="<%= cek.cek_no %>"
                                                data-vade="<%= cek.vade_formatted || ''%>"
                                                data-tutar="<%= cek.tutar %>"
                                                data-islem_tipi="<%= cek.islem_tipi %>"
                                                data-durum="<%= cek.durum %>"
                                                data-aciklama="<%= cek.aciklama %>"
                                            >
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger delete-btn" data-id="<%= cek.id %>">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    <% }) %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
        <!-- Çek Güncelleme ve Ekleme Modal -->
    <div class="modal fade" id="addCekModal" tabindex="-1" aria-labelledby="addCekModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addCekModalLabel">Yeni Çek Ekle</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
                </div>
                <div class="modal-body">
                    <form id="cekForm">
                        <input type="hidden" id="id" name="id">
                        <h5 class="mb-3">Genel Bilgiler</h5>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="cari_id" class="form-label">Cari</label>
                                <div class="input-group">
                                    <input type="hidden" id="cari_id" name="cari_id" required>
                                    <input type="text" class="form-control" id="cari_adi_goster" placeholder="Cari seçiniz" readonly required>
                                    <button type="button" class="btn btn-outline-secondary" id="openCariModal">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="kasa_banka_id" class="form-label">Kasa/Banka</label>
                                <select class="form-control" id="kasa_banka_id" name="kasa_banka_id" required>
                                    <option value="">Hesap Seçiniz</option>
                                    <% hesaplar.forEach(function(hesap) { %>
                                        <option value="<%= hesap.id %>"><%= hesap.tanimi %></option>
                                    <% }) %>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="cek_no" class="form-label">Çek No</label>
                                <input type="text" class="form-control" id="cek_no" name="cek_no" required>
                            </div>
                            <div class="col-md-4">
                                <label for="vade" class="form-label">Vade</label>
                                <input type="date" class="form-control" id="vade" name="vade" required>
                            </div>
                            <div class="col-md-4">
                                <label for="tutar" class="form-label">Tutar</label>
                                <input type="number" step="1" class="form-control" id="tutar" name="tutar" required>
                            </div>
                            <div class="col-md-4">
                                <label for="islem_tipi" class="form-label">İşlem Tipi</label>
                                <select class="form-control" id="islem_tipi" name="islem_tipi" required>
                                    <option value="">İşlem Seçiniz</option>
                                        <option value="0">Alış</option>
                                        <option value="1">Çıkış</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="durum" class="form-label">Durum</label>
                                <select class="form-control" id="durum" name="durum" required>
                                    <option value="">Durum Seçiniz</option>
                                    <option value="0">Ciro Edildi</option>
                                    <option value="1">Tahsil Edildi</option>
                                </select>
                            </div>
                            <div class="col-md-8">
                                <label for="aciklama" class="form-label">Açıklama</label>
                                <input type="text" class="form-control" id="aciklama" name="aciklama">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-primary" id="saveCek">Kaydet</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Cari Seç Modal -->
    <div class="modal fade" id="cariModal" tabindex="-1" aria-labelledby="cariModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cariModalLabel">Cari Seç</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
                </div>
                <div class="modal-body">
                    <input type="text" class="form-control mb-3" id="cariSearchInput" placeholder="Cari ara...">
                    <div style="max-height:400px;overflow:auto;">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Cari Kodu</th>
                                    <th>Unvan</th>
                                </tr>
                            </thead>
                            <tbody id="cariListBody">
                                <% cariler.forEach(function(cari) { %>
                                    <tr class="cari-row" data-id="<%= cari.id %>" data-carikodu="<%= cari.carikodu %>" data-unvan="<%= cari.unvan %>">
                                        <td><%= cari.id %></td>
                                        <td><%= cari.carikodu %></td>
                                        <td><%= cari.unvan %></td>
                                    </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/script.js"></script>
    <script>
        document.getElementById('saveCek').addEventListener('click', async function () {
            const form = document.getElementById('cekForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            // ❗️Gerekli alanların kontrolü
            const requiredFields = [
                { id: 'cari_id', name: 'Cari' },
                { id: 'kasa_banka_id', name: 'Kasa/Banka' },
                { id: 'cek_no', name: 'Çek No' },
                { id: 'vade', name: 'Vade' },
                { id: 'tutar', name: 'Tutar' },
                { id: 'islem_tipi', name: 'İşlem Tipi' },
                { id: 'durum', name: 'Durum' }
            ];

            for (let field of requiredFields) {
                const value = data[field.id]?.trim?.() ?? '';
                if (!value) {
                    alert(`${field.name} alanı boş olamaz.`);
                    document.getElementById(field.id).focus();
                    return;
                }
            }

            try {
                const response = await fetch('/hesaplarim/cekler', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    location.reload();
                } else {
                    alert('Kayıt sırasında bir hata oluştu: ' + result.message);
                }
            } catch (error) {
                console.error(error);
                alert('İşlem sırasında bir hata oluştu');
            }
        });
        //Silme İşlemi
        document.querySelector('.tab-pane.active tbody').addEventListener('click', async function(e) {
            const btn = e.target.closest('.delete-btn');
            if (!btn) return;

            if (!confirm('Çeki silmek istediğinize emin misiniz?')) return;

            const id = btn.dataset.id;

            try {
                const response = await fetch(`/hesaplarim/cekler/${id}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (result.success) {
                    btn.closest('tr').remove();
                    alert('Çek başarıyla silindi.');
                } else {
                    alert('Silme işlemi başarısız: ' + result.message);
                }
            } catch (err) {
                console.error('Silme hatası:', err);
                alert('Silme sırasında bir hata oluştu.');
            }
        });
        //Güncelleme İşlemi
        document.querySelector('.tab-pane.active tbody').addEventListener('click', function(e) {
            const btn = e.target.closest('.edit-btn');
            if (!btn) return;

            const modal = new bootstrap.Modal(document.getElementById('addCekModal'));
            const form = document.getElementById('cekForm');

            form.id.value = btn.dataset.id;
            form.cari_id.value = btn.dataset.cari_id;
            form.cari_adi_goster.value = btn.dataset.cari_adi;
            form.kasa_banka_id.value = btn.dataset.kasa_banka_id;
            form.cek_no.value = btn.dataset.cek_no;
            form.vade.value = btn.dataset.vade;
            form.tutar.value = btn.dataset.tutar;
            form.islem_tipi.value = btn.dataset.islem_tipi || '';
            form.durum.value = btn.dataset.durum || '';
            form.aciklama.value = btn.dataset.aciklama;

            console.log(form.id.value, form.cari_adi_goster.value);
            document.getElementById('addCekModalLabel').textContent = 'Çek Düzenle';
            modal.show();
        });

        document.getElementById('addCekBtn').addEventListener('click', () => {
            const form = document.getElementById('cekForm');
            form.reset();
            form.id.value = '';
            form.cari_id.value = '';
            form.cari_adi_goster.value = '';
            document.getElementById('addCekModalLabel').textContent = 'Çek Ekle';
        });
        // Cari Seç Modal açma
        const cariModal = new bootstrap.Modal(document.getElementById('cariModal'));
        document.getElementById('openCariModal').addEventListener('click', function() {
            cariModal.show();
            document.getElementById('cariSearchInput').value = '';
            filterCariList('');
        });
        // Cari arama
        function filterCariList(query) {
            query = query.toLowerCase();
            document.querySelectorAll('#cariListBody .cari-row').forEach(function(row) {
                const unvan = row.dataset.unvan.toLowerCase();
                row.style.display = unvan.includes(query) ? '' : 'none';
            });
        }
        document.getElementById('cariSearchInput').addEventListener('input', function() {
            filterCariList(this.value);
        });
        // Cari seçimi
        Array.from(document.querySelectorAll('#cariListBody .cari-row')).forEach(function(row) {
            row.addEventListener('click', function() {
                document.getElementById('cari_id').value = this.dataset.id;
                document.getElementById('cari_adi_goster').value = this.dataset.unvan;
                cariModal.hide();
            });
        });
        // Edit ve yeni kayıt için cari adı gösterimi
        function setCariInputFromData(cari_id, cari_adi) {
            document.getElementById('cari_id').value = cari_id || '';
            document.getElementById('cari_adi_goster').value = cari_adi || '';
        }


        // Filtre toggle fonksiyonu
        function toggleFilters() {
            const filterContent = document.getElementById('filterContent');
            const toggleIcon = document.getElementById('filterToggleIcon');
            
            if (filterContent.classList.contains('collapsed')) {
                filterContent.classList.remove('collapsed');
                toggleIcon.classList.remove('fa-chevron-down');
                toggleIcon.classList.add('fa-chevron-up');
            } else {
                filterContent.classList.add('collapsed');
                toggleIcon.classList.remove('fa-chevron-up');
                toggleIcon.classList.add('fa-chevron-down');
            }
        }

        function searchCekler() {
    const filters = {
        cari_arama: document.getElementById('cariArama').value,
        islem_tipi: document.getElementById('islem_tipi').value,
        cek_no: document.getElementById('cek_no').value,
        baslangic_tarih: document.getElementById('baslangicTarih').value,
        bitis_tarih: document.getElementById('bitisTarih').value,
        durum: document.getElementById('durum').value,
        siralama: document.getElementById('siralama').value
    };

    fetch('/hesaplarim/cekler/search', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(filters)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateCeklerTablosu(data.cekler);
        } else {
            alert('Arama sırasında hata oluştu: ' + data.message);
        }
    })
    .catch(error => {
        alert('Arama sırasında hata oluştu: ' + error.message);
    });
}

document.querySelectorAll('#cariArama, #hareketTuru,#siralama').forEach(input => {
    input.addEventListener('change', searchCekler);
});

document.querySelectorAll('#cariArama').forEach(input => {
    input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') searchCekler();
    });
});

function clearFilters() {
            document.getElementById('cariArama').value = '';
            document.getElementById('islem_tipi').value = '';
            document.getElementById('cek_no').value = '';
            document.getElementById('baslangicTarih').value = '2025-01-01';
            document.getElementById('bitisTarih').value = '2025-12-31';
            document.getElementById('durum').value = '';
            document.getElementById('siralama').value = 'date';
            searchCekler();
        }

function updateCeklerTablosu(cekler) {
    const tbody = document.querySelector('.tab-pane.active tbody');
    tbody.innerHTML = '';
    if (!cekler || cekler.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="text-center">Çek bulunamadı</td></tr>';
        return;
    }
    cekler.forEach(cek => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${cek.id}</td>
            <td>${cek.cari_adi || 'Belirtilmemiş'}</td>
            <td>${cek.hesap_adi || 'Belirtilmemiş'}</td>
            <td>${cek.cek_no}</td>
            <td>${cek.vade_formatted || ''}</td>
            <td>${cek.tutar}</td>
            <td>${cek.islem_tipi_text}</td>
            <td>${cek.durum_text}</td>
            <td>${cek.aciklama}</td>
            <td class="no-print">
                <button class="btn btn-sm btn-warning me-1 edit-btn"
                    data-id="${cek.id}"
                    data-cari_id="${cek.cari_id}"
                    data-cari_adi="${cek.cari_adi}"
                    data-kasa_banka_id="${cek.kasa_banka_id}"
                    data-hesap_adi="${cek.hesap_adi}"
                    data-cek_no="${cek.cek_no}"
                    data-vade="${cek.vade_formatted}"
                    data-tutar="${cek.tutar}"
                    data-islem_tipi="${cek.islem_tipi}"
                    data-durum="${cek.durum}"
                    data-aciklama="${cek.aciklama}"
                >
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-danger delete-btn" data-id="${cek.id}">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

        function exportToExcel() {
            alert('Excel export işlemi başlatıldı');
            // Excel export implementasyonu buraya eklenebilir
        }

        function exportToPDF() {
            alert('PDF export işlemi başlatıldı');
            // PDF export implementasyonu buraya eklenebilir
        }

        function printReport() {
            window.print();
        }
    </script>
</body>
</html>
