<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Çekler</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/css/dashboard.css" rel="stylesheet">
    <link href="/css/musteriler.css" rel="stylesheet">
</head>
<body>
    <%- include('../sidebar') %>
    <div class="main-content">
        <div class="product-container">
            <div class="page-header">
                <h1 class="page-title">Çekler</h1>
                <div class="action-buttons">
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCekModal" id="addCekBtn">
                        <i class="fas fa-plus"></i>
                        <span>Yeni Çek</span>
                    </button>
                </div>
            </div>
            <div class="search-area">
                <input type="text" class="form-control search-box" placeholder="Çek Ara...">
            </div>
            <div class="products-table">
                <div class="products-tabs mt-4">
                    <ul class="nav nav-tabs" id="cekTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="genel-tab" data-bs-toggle="tab" data-bs-target="#genel" type="button" role="tab">Genel Bilgiler</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="finans-tab" data-bs-toggle="tab" data-bs-target="#finans" type="button" role="tab">Finans Bilgileri</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="ek-tab" data-bs-toggle="tab" data-bs-target="#ek" type="button" role="tab">Ek Bilgiler</button>
                        </li>
                    </ul>
                    <div class="tab-content mt-3" id="cekTabContent">
                        <!-- GENEL BİLGİLER -->
                        <div class="tab-pane fade show active" id="genel" role="tabpanel">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Cari</th>
                                        <th>Kasa/Banka</th>
                                        <th>Çek No</th>
                                        <th>Vade</th>
                                        <th>Tutar</th>
                                        <th>İşlem Tipi</th>
                                        <th>Durum</th>
                                        <th>Açıklama</th>
                                        <th>İşlemler</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% cekler.forEach(function(cek) { %>
                                    <tr>
                                        <td><%= cek.id %></td>
                                        <td><%= cek.cari_adi || 'Belirtilmemiş' %></td>
                                        <td><%= cek.hesap_adi || 'Belirtilmemiş' %></td>
                                        <td><%= cek.cek_no %></td>
                                        <td><%= cek.vade_formatted || '' %></td>                                        <td><%= cek.tutar %></td>
                                        <td><%= cek.islem_tipi %></td>
                                        <td><%= cek.durum %></td>
                                        <td><%= cek.aciklama %></td>
                                        <td>
                                            <button class="btn btn-sm btn-warning me-1 edit-btn"
                                                data-id="<%= cek.id %>"
                                                data-cari_id="<%= cek.cari_id %>"
                                                data-cari_adi="<%= cek.cari_adi %>"
                                                data-kasa_banka_id="<%= cek.kasa_banka_id %>"
                                                data-hesap_adi="<%= cek.hesap_adi %>"
                                                data-cek_no="<%= cek.cek_no %>"
                                                data-vade="<%= cek.vade_formatted || ''%>"
                                                data-tutar="<%= cek.tutar %>"
                                                data-islem_tipi="<%= cek.islem_tipi %>"
                                                data-durum="<%= cek.durum %>"
                                                data-aciklama="<%= cek.aciklama %>"
                                            >
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger delete-btn" data-id="<%= cek.id %>">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    <% }) %>
                                </tbody>
                            </table>
                        </div>
                        <!-- FİNANS BİLGİLERİ (örnek, alanlar ihtiyaca göre değiştirilebilir) -->
                        <div class="tab-pane fade" id="finans" role="tabpanel">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Tutar</th>
                                        <th>Vade</th>
                                        <th>Durum</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% cekler.forEach(function(cek) { %>
                                    <tr>
                                        <td><%= cek.tutar %></td>
                                        <td><%= cek.vade %></td>
                                        <td><%= cek.durum %></td>
                                    </tr>
                                    <% }) %>
                                </tbody>
                            </table>
                        </div>
                        <!-- EK BİLGİLER (örnek, alanlar ihtiyaca göre değiştirilebilir) -->
                        <div class="tab-pane fade" id="ek" role="tabpanel">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Kaydeden Kullanıcı</th>
                                        <th>Güncelleyen Kullanıcı</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% cekler.forEach(function(cek) { %>
                                    <tr>
                                        <td><%= cek.kaydeden_kullanici %></td>
                                        <td><%= cek.guncelleyenkullanicikayitno %></td>
                                    </tr>
                                    <% }) %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
        <!-- Çek Güncelleme ve Ekleme Modal -->
    <div class="modal fade" id="addCekModal" tabindex="-1" aria-labelledby="addCekModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addCekModalLabel">Yeni Çek Ekle</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
                </div>
                <div class="modal-body">
                    <form id="cekForm">
                        <input type="hidden" id="id" name="id">
                        <h5 class="mb-3">Genel Bilgiler</h5>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="cari_id" class="form-label">Cari</label>
                                <div class="input-group">
                                    <input type="hidden" id="cari_id" name="cari_id" required>
                                    <input type="text" class="form-control" id="cari_adi_goster" placeholder="Cari seçiniz" readonly required>
                                    <button type="button" class="btn btn-outline-secondary" id="openCariModal">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="kasa_banka_id" class="form-label">Kasa/Banka</label>
                                <select class="form-control" id="kasa_banka_id" name="kasa_banka_id" required>
                                    <option value="">Hesap Seçiniz</option>
                                    <% hesaplar.forEach(function(hesap) { %>
                                        <option value="<%= hesap.id %>"><%= hesap.tanimi %></option>
                                    <% }) %>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="cek_no" class="form-label">Çek No</label>
                                <input type="text" class="form-control" id="cek_no" name="cek_no" required>
                            </div>
                            <div class="col-md-4">
                                <label for="vade" class="form-label">Vade</label>
                                <input type="date" class="form-control" id="vade" name="vade" required>
                            </div>
                            <div class="col-md-4">
                                <label for="tutar" class="form-label">Tutar</label>
                                <input type="number" step="1" class="form-control" id="tutar" name="tutar" required>
                            </div>
                            <div class="col-md-4">
                                <label for="islem_tipi" class="form-label">İşlem Tipi</label>
                                <select class="form-control" id="islem_tipi" name="islem_tipi" required>
                                    <option value="">İşlem Seçiniz</option>
                                        <option value="0">Alış</option>
                                        <option value="1">Çıkış</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="durum" class="form-label">Durum</label>
                                <select class="form-control" id="durum" name="durum" required>
                                    <option value="">Durum Seçiniz</option>
                                    <option value="0">Ciro Edildi</option>
                                    <option value="1">Tahsil Edildi</option>
                                </select>
                            </div>
                            <div class="col-md-8">
                                <label for="aciklama" class="form-label">Açıklama</label>
                                <input type="text" class="form-control" id="aciklama" name="aciklama">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-primary" id="saveCek">Kaydet</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Cari Seç Modal -->
    <div class="modal fade" id="cariModal" tabindex="-1" aria-labelledby="cariModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cariModalLabel">Cari Seç</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
                </div>
                <div class="modal-body">
                    <input type="text" class="form-control mb-3" id="cariSearchInput" placeholder="Cari ara...">
                    <div style="max-height:400px;overflow:auto;">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Cari Kodu</th>
                                    <th>Unvan</th>
                                </tr>
                            </thead>
                            <tbody id="cariListBody">
                                <% cariler.forEach(function(cari) { %>
                                    <tr class="cari-row" data-id="<%= cari.id %>" data-carikodu="<%= cari.carikodu %>" data-unvan="<%= cari.unvan %>">
                                        <td><%= cari.id %></td>
                                        <td><%= cari.carikodu %></td>
                                        <td><%= cari.unvan %></td>
                                    </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/script.js"></script>
    <script>
        document.getElementById('saveCek').addEventListener('click', async function() {
            const form = document.getElementById('cekForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            try {
                const response = await fetch('/hesaplarim/cekler', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (result.success) {
                    location.reload();
                } else {
                    alert('Kayıt sırasında bir hata oluştu: ' + result.message);
                }
            } catch (error) {
                alert('İşlem sırasında bir hata oluştu');
            }
        });
        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                if (!confirm('Çeki silmek istediğinize emin misiniz?')) return;
                const id = btn.dataset.id;
                const response = await fetch(`/hesaplarim/cekler/${id}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                if (result.success) {
                    btn.closest('tr').remove();
                    alert('Çek başarıyla silindi.');
                } else {
                    alert('Silme işlemi başarısız: ' + result.message);
                }
            });
        });
       
        document.querySelectorAll('.edit-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const modal = new bootstrap.Modal(document.getElementById('addCekModal'));
                const form = document.getElementById('cekForm');
                form.id.value = btn.dataset.id;
                form.cari_id.value = btn.dataset.cari_id;
                form.cari_adi_goster.value = btn.dataset.cari_adi;
                form.kasa_banka_id.value = btn.dataset.kasa_banka_id;
                form.cek_no.value = btn.dataset.cek_no;
                form.vade.value = btn.dataset.vade;                
                form.tutar.value = btn.dataset.tutar;
                form.islem_tipi.value = btn.dataset.islem_tipi || '';
                form.durum.value = btn.dataset.durum || '';
                form.aciklama.value = btn.dataset.aciklama;
                document.getElementById('addCekModalLabel').textContent = 'Çek Düzenle';
                modal.show();
            });
        });
        document.getElementById('addCekBtn').addEventListener('click', () => {
            const form = document.getElementById('cekForm');
            form.reset();
            form.id.value = '';
            form.cari_id.value = '';
            form.cari_adi_goster.value = '';
            document.getElementById('addCekModalLabel').textContent = 'Çek Ekle';
        });
        // Cari Seç Modal açma
        const cariModal = new bootstrap.Modal(document.getElementById('cariModal'));
        document.getElementById('openCariModal').addEventListener('click', function() {
            cariModal.show();
            document.getElementById('cariSearchInput').value = '';
            filterCariList('');
        });
        // Cari arama
        function filterCariList(query) {
            query = query.toLowerCase();
            document.querySelectorAll('#cariListBody .cari-row').forEach(function(row) {
                const unvan = row.dataset.unvan.toLowerCase();
                row.style.display = unvan.includes(query) ? '' : 'none';
            });
        }
        document.getElementById('cariSearchInput').addEventListener('input', function() {
            filterCariList(this.value);
        });
        // Cari seçimi
        Array.from(document.querySelectorAll('#cariListBody .cari-row')).forEach(function(row) {
            row.addEventListener('click', function() {
                document.getElementById('cari_id').value = this.dataset.id;
                document.getElementById('cari_adi_goster').value = this.dataset.unvan;
                cariModal.hide();
            });
        });
        // Edit ve yeni kayıt için cari adı gösterimi
        function setCariInputFromData(cari_id, cari_adi) {
            document.getElementById('cari_id').value = cari_id || '';
            document.getElementById('cari_adi_goster').value = cari_adi || '';
        }
    </script>
</body>
</html>
