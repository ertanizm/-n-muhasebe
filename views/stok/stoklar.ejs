<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mutabık - Müşteriler</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/css/dashboard.css" rel="stylesheet">
    <link href="/css/musteriler.css" rel="stylesheet">
    <link href="/css/filtre.css" rel="stylesheet">

</head>
<body>
    <%- include('../sidebar') %>

    <div class="main-content">
        <div class="product-container">
            <div class="page-header">
                <h1 class="page-title">Stoklar</h1>
                <div class="action-buttons">
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
                        <i class="fas fa-plus"></i>
                        <span>Yeni Stok</span>
                    </button>
                    <a href="/stok/stoklar/export" style="color: white;" class="btn btn-info">
                        <i class="fas fa-file-export"></i>
                        <span>Dışa Aktar</span>
                    </a>
                </div>
            </div>

            <!-- Filtreler -->
            <%- include('../filtre', {
                showIsimArama: true,
                isimAramaLabel: 'Stok Kodu/Adı',
                isimAramaPlaceholder: 'Stok ara...',
                showHareketTuru: false,
                showMusteriTuru: false,
                showStokGrup: true,
                showDepo: true,
                showTarih: true,
                showBakiye: true,
                showSirala: true
            }) %>

            
            <div class="products-table">
                <div class="products-tabs mt-4">
                    <ul class="nav nav-tabs" id="stokTab" role="tablist">
                      <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="genel-tab" data-bs-toggle="tab" data-bs-target="#genel" type="button" role="tab">Genel Bilgiler</button>
                      </li>
                      <li class="nav-item" role="presentation">
                        <button class="nav-link" id="satis-tab" data-bs-toggle="tab" data-bs-target="#satis" type="button" role="tab">Satış Bilgileri</button>
                      </li>
                      <li class="nav-item" role="presentation">
                        <button class="nav-link" id="ek-tab" data-bs-toggle="tab" data-bs-target="#ek" type="button" role="tab">Ek Bilgiler</button>
                      </li>
                    </ul>
                  
                    <div class="tab-content mt-3" id="stokTabContent">
                  
                      <!-- GENEL BİLGİLER -->
                      <div class="tab-pane fade show active" id="genel" role="tabpanel">
                        <table class="table table-striped">
                          <thead>
                            <tr>
                              <th>#</th>
                              <th>Stok Tipi</th>
                              <th>Stok Kodu</th>
                              <th>Stok Adı</th>
                              <th>Grup</th>
                              <th>Depo</th>
                              <th>Birim</th>
                              <th>Miktar</th>
                              <th>İşlemler</th>
                            </tr>
                          </thead>
                          <tbody>
                            <% stoklar.forEach(function(c) { %>
                              <tr>
                                <td><%= c.id %></td>
                                <td><%= c.stokText %></td>
                                <td><%= c.stok_kodu %></td>
                                <td><%= c.stok_adi %></td>
                                <td>
                                    <% 
                                    let grupAdi = '';
                                    for(let grup of gruplar) {
                                        if(grup.id == c.grupkayitno) {
                                            grupAdi = grup.grup_adi;
                                            break;
                                        }
                                    }
                                    %>
                                    <%= grupAdi %>
                                </td>
                                <td>
                                    <% 
                                    let depoAdi = '';
                                    for(let depo of depolar) {
                                        if(depo.id == c.depokayitno) {
                                            depoAdi = depo.depo_adi;
                                            break;
                                        }
                                    }
                                    %>
                                    <%= depoAdi %>
                                </td>
                                <td><%= c.birimText %></td>
                                <td><%= c.miktar %></td>
                                <td>
                                  <button class="btn btn-sm btn-warning me-1 edit-btn"
                                    data-id="<%= c.id %>"
                                    data-stok_kodu="<%= c.stok_kodu %>"
                                    data-stok_adi="<%= c.stok_adi %>"
                                    data-birim="<%= c.birim %>"
                                    data-miktar="<%= c.miktar %>"
                                    data-fiyat1="<%= c.fiyat1 %>"
                                    data-fiyat2="<%= c.fiyat2 %>"
                                    data-fiyat3="<%= c.fiyat3 %>"
                                    data-stoktipi="<%= c.stoktipi %>"
                                    data-aktif="<%= c.aktif %>"
                                    data-aktifbarkod="<%= c.aktifbarkod %>"
                                    data-kaydedenkullanicikayitno="<%= c.kaydedenkullanicikayitno %>"
                                    data-guncelleyenkullanicikayitno="<%= c.guncelleyenkullanicikayitno %>"
                                    data-grupkayitno="<%= c.grupkayitno %>"
                                    data-vergikayitno="<%= c.vergikayitno %>"
                                    data-depokayitno="<%= c.depokayitno %>"
                                    data-kayittarihi="<%= c.kayittarihi %>">
                                    <i class="fas fa-edit"></i>
                                  </button>
                                  <button class="btn btn-sm btn-danger delete-btn" data-id="<%= c.id %>">
                                    <i class="fas fa-trash-alt"></i>
                                  </button>
                                </td>
                              </tr>
                            <% }) %>
                          </tbody>
                        </table>
                      </div>
                  
                      <!-- SATIŞ BİLGİLERİ -->
                      <div class="tab-pane fade" id="satis" role="tabpanel">
                        <table class="table table-striped">
                          <thead>
                            <tr>
                              <th>Fiyat 1</th>
                              <th>Fiyat 2</th>
                              <th>Fiyat 3</th>
                              <th>Vergi</th>
                              <!-- <th>Stok Tipi</th> -->
                              <!-- <th>Aktif</th> -->
                            </tr>
                          </thead>
                          <tbody>
                            <% stoklar.forEach(function(c) { %>
                              <tr>
                                <td><%= c.fiyat1 %></td>
                                <td><%= c.fiyat2 %></td>
                                <td><%= c.fiyat3 %></td>
                                <td>
                                    <% 
                                    let vergiAdi = '';
                                    for(let vergi of vergiler) {
                                        if(vergi.id == c.vergikayitno) {
                                            vergiAdi = vergi.vergikodu;
                                            break;
                                        }
                                    }
                                    %>
                                    <%= vergiAdi %>
                                </td>                                
                                <!-- <td><%= c.stokText %></td> -->
                                <!-- <td><%= c.aktif %></td> -->
                              </tr>
                            <% }) %>
                          </tbody>
                        </table>
                      </div>
                  
                      <!-- EK BİLGİLER -->
                      <div class="tab-pane fade" id="ek" role="tabpanel">
                        <table class="table table-striped">
                          <thead>
                            <tr>
                              <th>Kaydeden Kullanıcı</th>
                              <th>Güncelleyen Kullanıcı</th>
                              <th>Kayıt Tarihi</th>
                            </tr>
                          </thead>
                          <tbody>
                            <% stoklar.forEach(function(c) { %>
                              <tr>
                                <td><%= c.kaydedenkullanicikayitno %></td>
                                <td><%= c.guncelleyenkullanicikayitno %></td>
                                <td><%= c.kayittarihiFormatted  %></td>
                              </tr>
                            <% }) %>
                          </tbody>
                        </table>
                      </div>
                  
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addProductModalLabel">Yeni Stok Ekle</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
                        <input type="hidden" id="id" name="id">
                
                        <!-- GENEL BİLGİLER -->
                        <h5 class="mb-3">Genel Bilgiler</h5>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="stok_kodu" class="form-label">Stok Kodu</label>
                                <input type="text" class="form-control" id="stok_kodu" name="stok_kodu">
                            </div>
                            <div class="col-md-8">
                                <label for="stok_adi" class="form-label">Stok Adı</label>
                                <input type="text" class="form-control" id="stok_adi" name="stok_adi" required>
                            </div>
                            <div class="col-md-4">
                                <label for="birim" class="form-label">Birim</label>
                                <select class="form-control" id="birim" name="birim">
                                    <option value="0">Adet</option>
                                    <option value="1">Kilogram</option>
                                    <option value="2">Litre</option>
                                    <option value="3">Paket</option>
                                    <option value="4">Metre</option>
                                    <option value="5">Koli</option>
                                    <option value="6">Kutu</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="miktar" class="form-label">Miktar</label>
                                <input type="text" class="form-control" id="miktar" name="miktar">
                            </div>
                            <div class="col-md-11">
                                <label for="aktifbarkod" class="form-label">Aktif Barkod</label>
                                <input type="text" class="form-control" id="aktifbarkod" name="aktifbarkod">
                            </div>
                            <div class="col-md-4">
                                <label for="grupkayitno" class="form-label">Grup Kayıt No</label>
                                 <select class="form-control" id="grupkayitno" name="grupkayitno">
                                    <option value="">Grup Seçiniz</option>
                                    <% gruplar.forEach(function(grup) { %>
                                        <option value="<%= grup.id %>"><%= grup.grup_adi %></option>
                                    <% }) %>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="vergikayitno" class="form-label">Vergi Kayıt No</label>
                                <select class="form-control" id="vergikayitno" name="vergikayitno">
                                    <option value="">Vergi Seçiniz</option>
                                    <% vergiler.forEach(function(vergi) { %>
                                        <option value="<%= vergi.id %>"><%= vergi.vergikodu %></option>
                                    <% }) %>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="depokayitno" class="form-label">Depo Kayıt No</label>
                                <select class="form-control" id="depokayitno" name="depokayitno">
                                    <option value="">Depo Seçiniz</option>
                                    <% depolar.forEach(function(depo) { %>
                                        <option value="<%= depo.id %>"><%= depo.depo_adi %></option>
                                    <% }) %>
                                </select>
                            </div>
                        </div>
                
                        <!-- SATIŞ BİLGİLERİ -->
                        <h5 class="mb-3 mt-4">Satış Bilgileri</h5>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="fiyat1" class="form-label">Fiyat 1</label>
                                <input type="number" step="0.01" class="form-control" id="fiyat1" name="fiyat1">
                            </div>
                            <div class="col-md-4">
                                <label for="fiyat2" class="form-label">Fiyat 2</label>
                                <input type="number" step="0.01" class="form-control" id="fiyat2" name="fiyat2">
                            </div>
                            <div class="col-md-4">  
                                <label for="fiyat3" class="form-label">Fiyat 3</label>
                                <input type="number" step="0.01" class="form-control" id="fiyat3" name="fiyat3">
                            </div>
                            <div class="col-md-4">
                                <label for="stoktipi" class="form-label">Stok Tipi</label>
                                <select class="form-control" id="stoktipi" name="stoktipi">
                                    <option value="0">Ürün</option>
                                    <option value="1">Hizmet</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="aktif" class="form-label">Aktif</label>
                                <select class="form-control" id="aktif" name="aktif">
                                    <option value="1">Evet</option>
                                    <option value="0">Hayır</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-primary" id="saveProduct">Kaydet</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/script.js"></script>
    <script>
        document.getElementById('saveProduct').addEventListener('click', async function() {
            const form = document.getElementById('productForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetch('/stok/stoklar', {  // Update API endpoint
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (result.success) {
                    location.reload(); // Sayfayı yenile
                } else {
                    alert('Kayıt sırasında bir hata oluştu: ' + result.message);
                }
            } catch (error) {
                alert('İşlem sırasında bir hata oluştu');
            }
        });

        // Update delete endpoint
        document.querySelector('.products-table tbody').addEventListener('click', async (e) => {
            const btn = e.target.closest('.delete-btn');
            if (!btn) return;

            if (!confirm('Stoğunuzu silmek istediğinize emin misiniz?')) return;

            const id = btn.dataset.id;
                const response = await fetch(`/stok/stoklar/${id}`, { 
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });

            const result = await response.json();
            if (result.success) {
                btn.closest('tr').remove();
                alert('Stok başarıyla silindi.');
            } else {
                alert('Silme işlemi başarısız: ' + result.message);
            }
        });

        // Edit butonu için event listener
        document.querySelector('.products-table tbody').addEventListener('click', (e) => {
            const btn = e.target.closest('.edit-btn');
            if (!btn) return;

            const modal = new bootstrap.Modal(document.getElementById('addProductModal'));
            const form = document.getElementById('productForm');

            // Form alanlarını doldur
            form.id.value = btn.dataset.id;
                form.stok_kodu.value = btn.dataset.stok_kodu;
                form.stok_adi.value = btn.dataset.stok_adi;
                form.birim.value = btn.dataset.birim;
                form.miktar.value = btn.dataset.miktar || "0";
                form.aktifbarkod.value = btn.dataset.aktifbarkod || "";
                form.grupkayitno.value = btn.dataset.grupkayitno || "";
                form.vergikayitno.value = btn.dataset.vergikayitno || "";
                form.depokayitno.value = btn.dataset.depokayitno || "";
                form.fiyat1.value = btn.dataset.fiyat1 || "";
                form.fiyat2.value = btn.dataset.fiyat2 || "";
                form.fiyat3.value = btn.dataset.fiyat3 || "";
                form.stoktipi.value = btn.dataset.stoktipi || "0";
                form.aktif.value = btn.dataset.aktif || "1";

            // Modal başlığını güncelle
            document.getElementById('addProductModalLabel').textContent = 'Stok Düzenle';
                
            modal.show();
        });
   
          // Filtre toggle fonksiyonu
        function toggleFilters() {
            const filterContent = document.getElementById('filterContent');
            const toggleIcon = document.getElementById('filterToggleIcon');
            
            if (filterContent.classList.contains('collapsed')) {
                filterContent.classList.remove('collapsed');
                toggleIcon.classList.remove('fa-chevron-down');
                toggleIcon.classList.add('fa-chevron-up');
            } else {
                filterContent.classList.add('collapsed');
                toggleIcon.classList.remove('fa-chevron-up');
                toggleIcon.classList.add('fa-chevron-down');
            }
        }
        
        // Enter tuşu ile arama
        document.querySelectorAll('#isimArama, #baslangicBakiye, #bitisBakiye').forEach(input => {
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchStokHareketler();
                }
            });
        });
        
        // Filtreleri temizle
        function clearFilters() {
            document.getElementById('isimArama').value = '';
            document.getElementById('stokGrubu').value = '';
            document.getElementById('depoId').value = '';
            document.getElementById('baslangicTarih').value = '2025-01-01';
            document.getElementById('bitisTarih').value = '2025-12-31';
            document.getElementById('baslangicBakiye').value = '0';
            document.getElementById('bitisBakiye').value = '999999';
            document.getElementById('siralama').value = 'date';
            searchFiltre();
        }

        function searchFiltre() {
            const filters = {
                stok_arama: document.getElementById('isimArama').value,
                stok_grup: document.getElementById('stokGrubu').value,
                depo: document.getElementById('depoId').value,
                baslangic_tarih: document.getElementById('baslangicTarih').value,
                bitis_tarih: document.getElementById('bitisTarih').value,
                baslangic_Bakiye: document.getElementById('baslangicBakiye').value,
                bitis_Bakiye: document.getElementById('bitisBakiye').value,
                siralama: document.getElementById('siralama').value
            };

            fetch('/stok/stoklar/search', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(filters)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateStoklarTablosu(data.stoklar);
                } else {
                    alert('Arama sırasında hata oluştu: ' + data.message);
                }
            })
            .catch(error => {
                alert('Arama sırasında hata oluştu: ' + error.message);
            });
        }

        function updateStoklarTablosu(stoklar) {
            const tbodygenel = document.querySelector('#genel tbody');
            const tbodysatis = document.querySelector('#satis tbody');
            const tbodyek = document.querySelector('#ek tbody');
            tbodygenel.innerHTML = '';
            tbodysatis.innerHTML = '';
            tbodyek.innerHTML = '';

            if (!stoklar || stoklar.length === 0) {
                tbodygenel.innerHTML = '<tr><td colspan="16" class="text-center">Kayıt bulunamadı</td></tr>';
                return;
            }

            stoklar.forEach(stok => {
                const rowgenel = document.createElement('tr');
                const rowsatis = document.createElement('tr');
                const rowek = document.createElement('tr');

                rowgenel.innerHTML = `
                    <td>${stok.id}</td>
                    <td>${stok.stokText || ''}</td>
                    <td>${stok.stok_kodu || ''}</td>
                    <td>${stok.stok_adi || ''}</td>
                    <td>${stok.grup_adi || ''}</td>
                    <td>${stok.depo_adi || ''}</td>
                    <td>${stok.birimText || ''}</td>
                    <td>${stok.miktar || ''}</td>
                    <td class="action-buttons no-print">
                        <button class="btn btn-sm btn-warning me-1 edit-btn"
                            data-id="${stok.id}"
                            data-stok_kodu="${stok.stok_kodu}"
                            data-stok_adi="${stok.stok_adi}"
                            data-birim="${stok.birim}"
                            data-miktar="${stok.miktar}"
                            data-fiyat1="${stok.fiyat1}"
                            data-fiyat2="${stok.fiyat2}"
                            data-fiyat3="${stok.fiyat3}"
                            data-stoktipi="${stok.stoktipi}"
                            data-aktif="${stok.aktif}"
                            data-kaydedenkullanicikayitno="${stok.kaydedenkullanicikayitno}"
                            data-guncelleyenkullanicikayitno="${stok.guncelleyenkullanicikayitno}"
                            data-grupkayitno="${stok.grupkayitno}"
                            data-vergikayitno="${stok.vergikayitno}"
                            data-kayittarihi="${stok.kayittarihi}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger delete-btn" data-id="${stok.id}">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                rowsatis.innerHTML = `
                    <td>${stok.fiyat1 || ''}</td>
                    <td>${stok.fiyat2 || ''}</td>
                    <td>${stok.fiyat3 || ''}</td>
                    <td>${stok.vergikayitno || ''}</td>
                `;
                rowek.innerHTML = `
                    <td>${stok.kaydedenkullanicikayitno || ''}</td>
                    <td>${stok.guncelleyenkullanicikayitno || ''}</td>
                    <td>${stok.kayittarihi || ''}</td>
                `;
                tbodygenel.appendChild(rowgenel);
                tbodysatis.appendChild(rowsatis);
                tbodyek.appendChild(rowek);
            });
        }

      
  
  </script>
</body>
</html>
